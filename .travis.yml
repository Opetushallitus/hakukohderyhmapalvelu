dist: xenial
language: java
jdk:
  - openjdk11
env:
  global:
    # AWS_ACCESS_KEY_ID
    - secure: "m1rkhNdLPZrsaBw2DMYvltn8kcgQPKvZ50f24dG+P1Wogdk9Pezgpwi+UQYnH7ejo1vejeAf/eAMkCPZUFS9LrhaiyKbRyaXller0mhutoIyKnY2hdidWuENAs8L4tpwLerFpKYH/qDp4ug5QLtj1Nqgd1nUwpneFSsDGdbW41djM6k8zx7DnUHCch2edR2on71k5+ilX6LEn2yWVrcOCtQeLujRuaNuefLVx//pG/I+CdooLMSFkit0Elum2s5uE+8Z2l+lKIzRLF4lvV5W40Vrfl3yO9iQLfg5TWE+xUYQqAlbQOqN5bTQBgRAjTwmz1cU5Ho2ll+xIGx5LfeCTx6PKrF8nFdB7UDBNFUJ6tDuVc5WCnmQ30LjBDliMJ01buDOcWwSWYLLLBjAVsJN8Aw62KkeLefaBfGfuQbp2L0Jinyt4Tnsj9zhY5/OBx/o4x1Vt/5v990sErKbfbTcBP8yU3DV4tXSZ0CpdAuyLKSI622gkfW7zDo/Px++5jc3E8TEfm9R7jImumyA/WxOpRhB9VBL9QhIMQOz4lVmoUBFVvc7YBBVc/mNE7M5IkhPX/VzdG6OsmtrCySgXqpTheemFDUmGRqrrESwvUIm/A/uhqnsa+E1iaMVQHL3e2DHaz7TK4R068vRPxylnVKUwJl5cUnTnkWmachojadsAqk="
    # AWS_SECRET_ACCESS_KEY
    - secure: "NDCxoOkwT5SbMzF/74OzObPJi9ZsnGMTjFHnStcBq5c0QmqqS6GQap2YxIEVpRH6oYj/p0RyNXCgvbf6bAaXmVcWmy1iaabjRl9DZr+mGTH9aNmntJ/W9Ldp3ZOCzEx4FKMJzNcz4GvfYuqjel5aaBU/jy/A4U8Fk0S6us2rw4JcLE6tpBxhHJJq5RDYIpq/hhbu/X8FNapQwC4FBN0LiZ9bFxRncWUVAbSvmfPybqnM2bNhLfjAd03V+14iG+Qk64et86RpYeoLvNXYxbwr8YYuwR4s0SKEK8PC4fUL5IPAyk0wCVhlkJJT6VFClVYcS9L8UHVqAfDOV2xn91Mb2cFjEQ+3asOkd+2HN1B7tORdrrIsrtgBmYnz/zoJ2kCw44L74+uYUceLXHeGO5WPocJoeINuB6lLj0XtQmaga6xBAwgvi6K6U9PBMBfeIUsRX2oCP6ClzLfEy3Vpugqi/gR6+ulJMjpsOO3wI6bbxA0bLwUsHH09dpxg8Dh9E6ra5raAVG1lt0jr/1Sd92EsiEE8A4Mo3fQHG5FrfVjIDt0kNuepW/GVCvFwSBWnzjjSOaNSWL2kFY6OkXOArh9wLG5pqQjGhq0Jpb5fvRsGLTL/L6fBhrJYUswraUmcFrmmtJPighrkDW/C9HhBuKX6Y0OsDvp8lCaqjn3Dt4v1ha0="
cache:
  npm: true
  directories:
    - $HOME/.m2
    - $HOME/.cache # cypress binary
    - node_modules
install:
  - git clone https://github.com/Opetushallitus/ci-tools.git
  - source ci-tools/common/setup-tools.sh
script: >-
  nvm install &&
  nvm use &&
  npm install &&
  ./bin/cibuild.sh run-all-tests-and-create-uberjar &&
  bin/lein with-profile prod uberjar &&
  export BASE_IMAGE="baseimage-fatjar-openjdk11:master" &&
  ./ci-tools/common/pull-image.sh &&
  cp -v ./target/hakukohderyhmapalvelu.jar $DOCKER_BUILD_DIR/artifact/hakukohderyhmapalvelu.jar &&
  cp -vr ./oph-configuration $DOCKER_BUILD_DIR/config/ &&
  ./ci-tools/build/build-fatjar.sh hakukohderyhmapalvelu
deploy:
  provider: script
  script: >-
    ./ci-tools/build/upload-image.sh hakukohderyhmapalvelu
  on:
    all_branches: true
